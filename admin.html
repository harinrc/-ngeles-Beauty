<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Admin - Ángeles Beauty</title>
    
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

    <main class="admin-container">
        
        <div class="admin-header">
            <h1>Panel de Administración</h1>
            <button id="logout-button" class="boton-comprar" style="background-color: #d9534f;">Cerrar Sesión</button>
        </div>

        <form id="add-product-form" class="admin-form">
            <h2>Añadir Nuevo Producto</h2>
            
            <div class="form-group">
                <label for="prod-nombre">Nombre del Producto:</label>
                <input type="text" id="prod-nombre" required>
            </div>
            
            <div class="form-group">
                <label for="prod-precio">Precio (Ej: C$100):</label>
                <input type="text" id="prod-precio" required>
            </div>

            <div class="form-group">
                <label for="prod-imagen">Ruta de Imagen (Ej: Imagenes/foto.jpg):</label>
                <input type="text" id="prod-imagen" required>
            </div>
            
            <button type="submit" class="boton-comprar">Guardar Producto</button>
            <p id="add-message" class="exito-texto"></p>
        </form>

        </form>

        <div class="lista-productos-admin">
            <h2>Productos Actuales</h2>
            
            <div id="lista-productos-container">
                <p>Cargando lista de productos...</p>
            </div>
        </div>
        
    </main> ```

---


        </main>


   <script type="module">
    
      // --- 1. INICIALIZACIÓN DE FIREBASE ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
      
      // Imports de Autenticación
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
      
      // Imports de Firestore (¡CON TODO LO NUEVO!)
      import { 
          getFirestore, 
          collection, 
          addDoc,       // Para crear
          getDocs,      // Para leer
          doc,          // Para apuntar a un documento
          deleteDoc     // Para borrar
      } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";
      
      // Pega tu mismo 'firebaseConfig' de los otros archivos
      const firebaseConfig = {
        apiKey: "AIzaSyBYW_DwpaBSYYtxAVulvpJQw16_uFDEM6o",
    authDomain: "angeles-beauty-tienda.firebaseapp.com",
    projectId: "angeles-beauty-tienda",
    storageBucket: "angeles-beauty-tienda.firebasestorage.app",
    messagingSenderId: "187820526775",
    appId: "1:187820526775:web:afafeb48179439becb5132",
    measurementId: "G-39814RTTJ5"
      };

      // Inicializa Firebase App, Auth y Firestore
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);


      // --- 2. EL "GUARDIÁN DE AUTENTICACIÓN" (Auth Guard) ---
      
      onAuthStateChanged(auth, (user) => {
          if (user) {
              // ¡Sí hay un usuario! Está logueado.
              console.log("Acceso permitido para:", user.email);
              
              // ¡NUEVO! Si el usuario está logueado, cargamos la lista de productos.
              cargarProductosAdmin();

          } else {
              // ¡No hay usuario! No ha iniciado sesión.
              console.log("Acceso denegado. Redirigiendo a login...");
              window.location.href = 'login.html';
          }
      });


      // --- 3. LÓGICA PARA CERRAR SESIÓN (Logout) ---
      // (Este código es el mismo de antes)
      const logoutButton = document.querySelector('#logout-button');
      if (logoutButton) {
          logoutButton.addEventListener('click', async () => {
              try {
                  await signOut(auth); 
                  window.location.href = 'login.html';
              } catch (error) {
                  console.error("Error al cerrar sesión:", error);
              }
          });
      }


      // --- 4. LÓGICA DEL FORMULARIO PARA AÑADIR PRODUCTOS ---
      // (Este código es el mismo de antes)
      const addForm = document.querySelector('#add-product-form');
      const addMsg = document.querySelector('#add-message');

      if (addForm) {
          addForm.addEventListener('submit', async (e) => {
              e.preventDefault(); 
              const nombre = addForm['prod-nombre'].value;
              const precio = addForm['prod-precio'].value;
              const imagenUrl = addForm['prod-imagen'].value;

              try {
                  const docRef = await addDoc(collection(db, 'productos'), {
                      nombre: nombre,
                      precio: precio,
                      imagenUrl: imagenUrl
                  });
                  
                  addMsg.textContent = "¡Producto guardado con éxito!";
                  addForm.reset(); 
                  setTimeout(() => { addMsg.textContent = ""; }, 3000);
                  
                  // ¡NUEVO! Después de añadir, refrescamos la lista.
                  cargarProductosAdmin(); 

              } catch (error) {
                  console.error("Error al guardar producto:", error);
                  addMsg.textContent = "Error al guardar el producto.";
              }
          });
      }

      // --- 5. ¡NUEVO! LÓGICA PARA LEER Y MOSTRAR LA LISTA DE PRODUCTOS ---
      
      const listaContainer = document.querySelector('#lista-productos-container');

      async function cargarProductosAdmin() {
          if (!listaContainer) return; // Si no existe el contenedor, no hagas nada
          
          listaContainer.innerHTML = "<p>Cargando lista de productos...</p>";
          let html = ""; // Aquí construiremos el HTML de la lista

          try {
              const productosSnapshot = await getDocs(collection(db, 'productos'));
              
              if (productosSnapshot.empty) {
                  listaContainer.innerHTML = "<p>No hay productos en la base de datos.</p>";
                  return;
              }

              productosSnapshot.forEach(doc => {
                  const producto = doc.data();
                  const id = doc.id; // ¡CRUCIAL! Necesitamos el ID para borrar

                  html += `
                      <div class="producto-item-admin">
                          <span>${producto.nombre}</span>
                          <div class="botones-admin">
                              <button class="boton-admin-editar" data-id="${id}">Editar</button>
                              <button class="boton-admin-eliminar" data-id="${id}">Eliminar</button>
                          </div>
                      </div>
                  `;
              });
              
              listaContainer.innerHTML = html; // Dibujamos la lista completa

              // --- 6. ¡NUEVO! AÑADIR LOS "ESCUCHADORES" A LOS BOTONES ---
              
              // Añadir listeners para todos los botones de ELIMINAR
              document.querySelectorAll('.boton-admin-eliminar').forEach(button => {
                  button.addEventListener('click', async (e) => {
                      const id = e.target.dataset.id; // Obtenemos el ID del producto
                      
                      // ¡Pregunta de confirmación vital!
                      if (confirm("¿Estás seguro de que quieres eliminar este producto?")) {
                          await eliminarProducto(id);
                      }
                  });
              });

              // (Aquí pondremos los listeners de "Editar" en el futuro)

          } catch (error) {
              console.error("Error al cargar la lista de productos:", error);
              listaContainer.innerHTML = "<p>Error al cargar la lista.</p>";
          }
      }

      // --- 7. ¡NUEVO! FUNCIÓN PARA ELIMINAR UN PRODUCTO ---
      
      async function eliminarProducto(id) {
          try {
              // 1. Apuntar al documento exacto usando su ID
              const productoDoc = doc(db, 'productos', id);
              
              // 2. Borrarlo
              await deleteDoc(productoDoc);
              
              console.log("Producto eliminado con éxito");
              
              // 3. Refrescar la lista para que desaparezca
              cargarProductosAdmin(); 
              
          } catch (error) {
              console.error("Error al eliminar el producto:", error);
              alert("Error al eliminar el producto.");
          }
      }

    </script>
</body>
</html>
