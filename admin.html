<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Admin - Ángeles Beauty</title>
    
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

    <main class="admin-container">
        
        <div class="admin-header">
            <h1>Panel de Administración</h1>
            <button id="logout-button" class="boton-comprar" style="background-color: #d9534f;">Cerrar Sesión</button>
        </div>

        <form id="add-product-form" class="admin-form">
            <h2 id="form-titulo">Añadir Nuevo Producto</h2>
            <input type="hidden" id="prod-id">
            
            <div class="form-group">
                <label for="prod-nombre">Nombre del Producto:</label>
                <input type="text" id="prod-nombre" required>
            </div>
            
            <div class="form-group">
                <label for="prod-precio">Precio (Ej: C$100):</label>
                <input type="text" id="prod-precio" required>
            </div>

            <div class="form-group">
                <label for="prod-imagen">Ruta de Imagen (Ej: Imagenes/foto.jpg):</label>
                <input type="text" id="prod-imagen" required>
            </div>
            
            <button type="submit" class="boton-comprar">Guardar Producto</button>
            <button type="button" id="boton-cancelar" class="boton-admin-editar" style="background-color: #777; display: none;">Cancelar Edición</button>
            <p id="add-message" class="exito-texto"></p>
        </form>

        </form>

        <div class="lista-productos-admin">
            <h2>Productos Actuales</h2>
            
            <div id="lista-productos-container">
                <p>Cargando lista de productos...</p>
            </div>
        </div>
        
    </main> ```

---


        </main>


   <script type="module">
    
      // --- 1. INICIALIZACIÓN DE FIREBASE ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
      
      // Imports de Autenticación
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
      
      // Imports de Firestore (CRUD)
      import { 
          getFirestore, collection, addDoc, getDocs, 
          getDoc, doc, deleteDoc, updateDoc 
      } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";
          
      // ¡¡NUEVO!! Imports de Storage (para subir archivos)
      import { 
          getStorage, 
          ref,                 // Apunta a un archivo
          uploadBytesResumable, // Para subir el archivo
          getDownloadURL      // Para obtener la URL pública
      } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-storage.js";
      
      // ¡¡MUY IMPORTANTE!!
      // Pega aquí tu NUEVO 'firebaseConfig' del proyecto v2
       const firebaseConfig = {
    apiKey: "AIzaSyAPUPxZNuJfX3KtiI1p73AAfDgNqVo8a-g",
    authDomain: "tienda-angeles-beauty.firebaseapp.com",
    projectId: "tienda-angeles-beauty",
    storageBucket: "tienda-angeles-beauty.firebasestorage.app",
    messagingSenderId: "913588395045",
    appId: "1:913588395045:web:ce50c2f7a296c85ecff3cc"
  };

      // Inicializa TODOS los servicios
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app); // ¡NUEVO!


      // --- 2. EL "GUARDIÁN DE AUTENTICACIÓN" (Auth Guard) ---
      onAuthStateChanged(auth, (user) => {
          if (user) {
              console.log("Acceso permitido para:", user.email);
              cargarProductosAdmin(); 
          } else {
              console.log("Acceso denegado. Redirigiendo a login...");
              window.location.href = 'login.html';
          }
      });

      // --- 3. LÓGICA PARA CERRAR SESIÓN (Logout) ---
      const logoutButton = document.querySelector('#logout-button');
      logoutButton.addEventListener('click', async () => {
          await signOut(auth); 
          window.location.href = 'login.html';
      });

      // --- 4. LÓGICA DEL FORMULARIO (¡VERSIÓN FINAL!) ---
      
      // Seleccionamos todos los elementos del formulario
      const addForm = document.querySelector('#add-product-form');
      const addMsg = document.querySelector('#add-message');
      const formTitulo = document.querySelector('#form-titulo');
      const formBotonGuardar = addForm.querySelector('button[type="submit"]');
      const botonCancelar = document.querySelector('#boton-cancelar');
      const campoIdOculto = document.querySelector('#prod-id');
      const campoImagenActual = document.querySelector('#prod-imagen-actual');
      const inputArchivo = document.querySelector('#prod-imagen');
      const previewContainer = document.querySelector('#preview-container');
      const previewImagen = document.querySelector('#current-image-preview');

      // Escuchador principal del formulario
      addForm.addEventListener('submit', async (e) => {
          e.preventDefault(); 
          
          const nombre = addForm['prod-nombre'].value;
          const precio = addForm['prod-precio'].value;
          const id = campoIdOculto.value;
          const archivo = inputArchivo.files[0]; // El archivo seleccionado

          // Deshabilitamos el botón para evitar clics dobles
          formBotonGuardar.disabled = true;
          formBotonGuardar.textContent = "Guardando...";

          try {
              let imagenUrlFinal = campoImagenActual.value; // Por defecto, es la imagen que ya estaba

              // PASO 1: ¿El usuario subió un archivo nuevo?
              if (archivo) {
                  // ¡Sí! Hay que subirlo a Storage
                  mostrarMensaje("Subiendo imagen...", "exito-texto");
                  
                  // Crea una referencia única (ej. "productos/16788865...-mi-foto.jpg")
                  const storageRef = ref(storage, `productos/${Date.now()}-${archivo.name}`);
                  
                  // Sube el archivo
                  const uploadTask = await uploadBytesResumable(storageRef, archivo);
                  
                  // Obtiene la URL pública de descarga
                  imagenUrlFinal = await getDownloadURL(uploadTask.ref);
                  
                  mostrarMensaje("¡Imagen subida! Guardando producto...", "exito-texto");
              }

              // PASO 2: ¿Estamos Editando (Update) o Creando (Create)?
              const datosProducto = {
                  nombre: nombre,
                  precio: precio,
                  imagenUrl: imagenUrlFinal // Usamos la URL (nueva o la vieja)
              };

              if (id) {
                  // --- MODO ACTUALIZAR (UPDATE) ---
                  const productoDoc = doc(db, 'productos', id);
                  await updateDoc(productoDoc, datosProducto);
                  mostrarMensaje("¡Producto actualizado!", "exito-texto");
              } else {
                  // --- MODO AÑADIR (CREATE) ---
                  await addDoc(collection(db, 'productos'), datosProducto);
                  mostrarMensaje("¡Producto guardado con éxito!", "exito-texto");
              }
              
              resetearFormulario(); 
              cargarProductosAdmin(); 

          } catch (error) {
              console.error("Error al guardar:", error);
              mostrarMensaje(`Error al guardar: ${error.message}`, "error-texto");
          } finally {
              // Volvemos a habilitar el botón
              formBotonGuardar.disabled = false;
              resetearFormulario();
          }
      });
      
      // Escuchador para el botón de Cancelar
      botonCancelar.addEventListener('click', () => {
          resetearFormulario();
      });

      // Función para limpiar el formulario y volver a modo "Añadir"
      function resetearFormulario() {
          addForm.reset(); 
          campoIdOculto.value = ""; 
          campoImagenActual.value = "";
          formTitulo.textContent = "Añadir Nuevo Producto";
          formBotonGuardar.textContent = "Guardar Producto";
          botonCancelar.style.display = "none";
          previewContainer.style.display = "none"; // Oculta el preview
      }

      // Función para mostrar mensajes
      function mostrarMensaje(texto, clase) {
          addMsg.textContent = texto;
          addMsg.className = clase;
          // Hacemos que el mensaje de éxito dure un poco más
          if (clase === "exito-texto") {
              setTimeout(() => { addMsg.textContent = ""; }, 4000);
          }
      }

      // --- 5. LÓGICA PARA LEER Y MOSTRAR LA LISTA DE PRODUCTOS ---
      const listaContainer = document.querySelector('#lista-productos-container');

      async function cargarProductosAdmin() {
          // (Esta función es la misma de antes, no cambia)
          if (!listaContainer) return; 
          listaContainer.innerHTML = "<p>Cargando lista de productos...</p>";
          let html = ""; 

          try {
              const productosSnapshot = await getDocs(collection(db, 'productos'));
              if (productosSnapshot.empty) {
                  listaContainer.innerHTML = "<p>No hay productos en la base de datos.</p>";
                  return;
              }

              productosSnapshot.forEach(doc => {
                  const producto = doc.data();
                  const id = doc.id; 
                  html += `
                      <div class="producto-item-admin">
                          <span>${producto.nombre}</span>
                          <div class="botones-admin">
                              <button class="boton-admin-editar" data-id="${id}">Editar</button>
                              <button class="boton-admin-eliminar" data-id="${id}">Eliminar</button>
                          </div>
                      </div>
                  `;
              });
              listaContainer.innerHTML = html; 

              // --- 6. AÑADIR LOS "ESCUCHADORES" A LOS BOTONES ---
              
              // Listeners para ELIMINAR (igual que antes)
              document.querySelectorAll('.boton-admin-eliminar').forEach(button => {
                  button.addEventListener('click', async (e) => {
                      const id = e.target.dataset.id; 
                      if (confirm("¿Estás seguro de que quieres eliminar este producto? (La imagen en Storage no se borrará automáticamente)")) {
                          await eliminarProducto(id);
                      }
                  });
              });

              // Listeners para EDITAR (igual que antes)
              document.querySelectorAll('.boton-admin-editar').forEach(button => {
                  button.addEventListener('click', (e) => {
                      const id = e.target.dataset.id; 
                      prepararEdicion(id); 
                  });
              });

          } catch (error) {
              console.error("Error al cargar la lista de productos:", error);
              listaContainer.innerHTML = "<p>Error al cargar la lista.</p>";
          }
      }

      // --- 7. FUNCIÓN PARA ELIMINAR UN PRODUCTO (Firestore) ---
      // (Esta función es la misma, solo borra la entrada de Firestore)
      async function eliminarProducto(id) {
          try {
              await deleteDoc(doc(db, 'productos', id));
              cargarProductosAdmin(); 
          } catch (error) {
              console.error("Error al eliminar el producto:", error);
              alert("Error al eliminar el producto.");
          }
      }

      // --- 8. FUNCIÓN PARA PREPARAR LA EDICIÓN (¡ACTUALIZADA!) ---
      async function prepararEdicion(id) {
          try {
              const productoDocRef = doc(db, 'productos', id);
              const productoSnap = await getDoc(productoDocRef);
              if (!productoSnap.exists()) return;
              
              const producto = productoSnap.data();

              // Rellenar el formulario
              formTitulo.textContent = `Editando: ${producto.nombre}`;
              addForm['prod-nombre'].value = producto.nombre;
              addForm['prod-precio'].value = producto.precio;
              campoIdOculto.value = id; 

              // ¡NUEVO! Manejar la imagen
              if (producto.imagenUrl) {
                  previewImagen.src = producto.imagenUrl; // Muestra la imagen actual
                  campoImagenActual.value = producto.imagenUrl; // Guarda la URL vieja
                  previewContainer.style.display = "block"; // Muestra el preview
              }
              
              // Cambiar los botones
              formBotonGuardar.textContent = "Actualizar Producto";
              botonCancelar.style.display = "inline-block"; 

              window.scrollTo({ top: 0, behavior: 'smooth' });

          } catch (error) {
              console.error("Error al preparar la edición:", error);
          }
      }

    </script>
</body>
</html>
