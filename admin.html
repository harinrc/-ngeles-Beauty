<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Admin - Ángeles Beauty</title>
    
    <link rel="stylesheet" href="style.css"> 
</head>
<body>

    <main class="admin-container">
        
        <div class="admin-header">
            <h1>Panel de Administración</h1>
            <button id="logout-button" class="boton-comprar" style="background-color: #d9534f;">Cerrar Sesión</button>
        </div>

        <form id="add-product-form" class="admin-form">
            <h2 id="form-titulo">Añadir Nuevo Producto</h2>
            <input type="hidden" id="prod-id">
            
            <div class="form-group">
                <label for="prod-nombre">Nombre del Producto:</label>
                <input type="text" id="prod-nombre" required>
            </div>
            
            <div class="form-group">
                <label for="prod-precio">Precio (Ej: C$100):</label>
                <input type="text" id="prod-precio" required>
            </div>

            <div class="form-group">
                <label for="prod-imagen">Ruta de Imagen (Ej: Imagenes/foto.jpg):</label>
                <input type="text" id="prod-imagen" required>
            </div>
            
            <button type="submit" class="boton-comprar">Guardar Producto</button>
            <button type="button" id="boton-cancelar" class="boton-admin-editar" style="background-color: #777; display: none;">Cancelar Edición</button>
            <p id="add-message" class="exito-texto"></p>
        </form>

        </form>

        <div class="lista-productos-admin">
            <h2>Productos Actuales</h2>
            
            <div id="lista-productos-container">
                <p>Cargando lista de productos...</p>
            </div>
        </div>
        
    </main> ```

---


        </main>


   <script type="module">
    
      // --- 1. INICIALIZACIÓN DE FIREBASE ---
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
      
      // Imports de Autenticación
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
      
      // Imports de Firestore (¡CON TODO!)
      import { 
          getFirestore, 
          collection,    // Para 'productos'
          addDoc,        // Para Crear
          getDocs,       // Para Leer (lista)
          getDoc,        // Para Leer (uno solo)
          doc,           // Para apuntar a un documento
          deleteDoc,     // Para Borrar
          updateDoc      // ¡¡NUEVO!! Para Actualizar
      } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";
      
      // Pega tu mismo 'firebaseConfig'
       const firebaseConfig = {
    apiKey: "AIzaSyAPUPxZNuJfX3KtiI1p73AAfDgNqVo8a-g",
    authDomain: "tienda-angeles-beauty.firebaseapp.com",
    projectId: "tienda-angeles-beauty",
    storageBucket: "tienda-angeles-beauty.firebasestorage.app",
    messagingSenderId: "913588395045",
    appId: "1:913588395045:web:ce50c2f7a296c85ecff3cc"
  };

      // Inicializa Firebase App, Auth y Firestore
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);


      // --- 2. EL "GUARDIÁN DE AUTENTICACIÓN" (Auth Guard) ---
      onAuthStateChanged(auth, (user) => {
          if (user) {
              console.log("Acceso permitido para:", user.email);
              cargarProductosAdmin(); // Cargar la lista al entrar
          } else {
              console.log("Acceso denegado. Redirigiendo a login...");
              window.location.href = 'login.html';
          }
      });


      // --- 3. LÓGICA PARA CERRAR SESIÓN (Logout) ---
      const logoutButton = document.querySelector('#logout-button');
      if (logoutButton) {
          logoutButton.addEventListener('click', async () => {
              await signOut(auth); 
              window.location.href = 'login.html';
          });
      }


      // --- 4. LÓGICA DEL FORMULARIO (¡AHORA ES INTELIGENTE!) ---
      
      const addForm = document.querySelector('#add-product-form');
      const addMsg = document.querySelector('#add-message');
      const formTitulo = document.querySelector('#form-titulo');
      const formBotonGuardar = addForm.querySelector('button[type="submit"]');
      const botonCancelar = document.querySelector('#boton-cancelar');
      const campoIdOculto = document.querySelector('#prod-id');

      addForm.addEventListener('submit', async (e) => {
          e.preventDefault(); 
          
          const nombre = addForm['prod-nombre'].value;
          const precio = addForm['prod-precio'].value;
          const imagenUrl = addForm['prod-imagen'].value;
          const id = campoIdOculto.value; // Leemos el ID oculto

          try {
              if (id) {
                  // --- MODO ACTUALIZAR (UPDATE) ---
                  // Si hay un ID, actualizamos el documento existente
                  const productoDoc = doc(db, 'productos', id);
                  await updateDoc(productoDoc, {
                      nombre: nombre,
                      precio: precio,
                      imagenUrl: imagenUrl
                  });
                  mostrarMensaje("¡Producto actualizado!", "exito-texto");
                  
              } else {
                  // --- MODO AÑADIR (CREATE) ---
                  // Si no hay ID, creamos un documento nuevo
                  await addDoc(collection(db, 'productos'), {
                      nombre: nombre,
                      precio: precio,
                      imagenUrl: imagenUrl
                  });
                  mostrarMensaje("¡Producto guardado con éxito!", "exito-texto");
              }
              
              resetearFormulario(); // Limpiar y volver a modo "Añadir"
              cargarProductosAdmin(); // Recargar la lista de productos

          } catch (error) {
              console.error("Error al guardar:", error);
              mostrarMensaje("Error al guardar el producto.", "error-texto");
          }
      });
      
      // ¡NUEVO! Escuchador para el botón de Cancelar
      botonCancelar.addEventListener('click', () => {
          resetearFormulario();
      });

      // ¡NUEVO! Función para limpiar el formulario y volver a modo "Añadir"
      function resetearFormulario() {
          addForm.reset(); // Limpia los campos
          campoIdOculto.value = ""; // Limpia el ID oculto
          formTitulo.textContent = "Añadir Nuevo Producto";
          formBotonGuardar.textContent = "Guardar Producto";
          botonCancelar.style.display = "none"; // Oculta el botón "Cancelar"
      }

      // Función para mostrar mensajes
      function mostrarMensaje(texto, clase) {
          addMsg.textContent = texto;
          addMsg.className = clase;
          setTimeout(() => { addMsg.textContent = ""; }, 3000);
      }


      // --- 5. LÓGICA PARA LEER Y MOSTRAR LA LISTA DE PRODUCTOS ---
      
      const listaContainer = document.querySelector('#lista-productos-container');

      async function cargarProductosAdmin() {
          if (!listaContainer) return; 
          listaContainer.innerHTML = "<p>Cargando lista de productos...</p>";
          let html = ""; 

          try {
              const productosSnapshot = await getDocs(collection(db, 'productos'));
              if (productosSnapshot.empty) {
                  listaContainer.innerHTML = "<p>No hay productos en la base de datos.</p>";
                  return;
              }

              productosSnapshot.forEach(doc => {
                  const producto = doc.data();
                  const id = doc.id; 

                  html += `
                      <div class="producto-item-admin">
                          <span>${producto.nombre}</span>
                          <div class="botones-admin">
                              <button class="boton-admin-editar" data-id="${id}">Editar</button>
                              <button class="boton-admin-eliminar" data-id="${id}">Eliminar</button>
                          </div>
                      </div>
                  `;
              });
              
              listaContainer.innerHTML = html; 

              // --- 6. AÑADIR LOS "ESCUCHADORES" A LOS BOTONES ---
              
              // Listeners para ELIMINAR (igual que antes)
              document.querySelectorAll('.boton-admin-eliminar').forEach(button => {
                  button.addEventListener('click', async (e) => {
                      const id = e.target.dataset.id; 
                      if (confirm("¿Estás seguro de que quieres eliminar este producto?")) {
                          await eliminarProducto(id);
                      }
                  });
              });

              // ¡NUEVO! Listeners para EDITAR
              document.querySelectorAll('.boton-admin-editar').forEach(button => {
                  button.addEventListener('click', (e) => {
                      const id = e.target.dataset.id; 
                      prepararEdicion(id); // Llama a la nueva función
                  });
              });

          } catch (error) {
              console.error("Error al cargar la lista de productos:", error);
              listaContainer.innerHTML = "<p>Error al cargar la lista.</p>";
          }
      }

      // --- 7. FUNCIÓN PARA ELIMINAR UN PRODUCTO ---
      
      async function eliminarProducto(id) {
          try {
              await deleteDoc(doc(db, 'productos', id));
              cargarProductosAdmin(); // Refrescar la lista
          } catch (error) {
              console.error("Error al eliminar el producto:", error);
              alert("Error al eliminar el producto.");
          }
      }

      // --- 8. ¡NUEVO! FUNCIÓN PARA PREPARAR LA EDICIÓN ---
      
      async function prepararEdicion(id) {
          try {
              // 1. Buscar el documento específico en Firebase
              const productoDocRef = doc(db, 'productos', id);
              const productoSnap = await getDoc(productoDocRef);

              if (!productoSnap.exists()) {
                  console.error("No se encontró el producto");
                  return;
              }
              
              const producto = productoSnap.data();

              // 2. Rellenar el formulario
              formTitulo.textContent = `Editando: ${producto.nombre}`;
              addForm['prod-nombre'].value = producto.nombre;
              addForm['prod-precio'].value = producto.precio;
              addForm['prod-imagen'].value = producto.imagenUrl;
              campoIdOculto.value = id; // ¡CLAVE! Guardamos el ID

              // 3. Cambiar los botones
              formBotonGuardar.textContent = "Actualizar Producto";
              botonCancelar.style.display = "inline-block"; // Muestra "Cancelar"

              // 4. Mover la pantalla hacia arriba (al formulario)
              window.scrollTo({ top: 0, behavior: 'smooth' });

          } catch (error) {
              console.error("Error al preparar la edición:", error);
          }
      }

    </script>
</body>
</html>
